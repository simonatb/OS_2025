# Обработка на структуриран текст с awk #
awk е език за програмиране, специализиран за обработка на табличен
текст
- Командата awk приема скрипт, написан на езика awk, и го изпълнява
върху текста, получен на stdin
```
 $ awk -f <скрипт> чете awk-скрипт от файл вместо от аргумент
```
### скриптове ###
```
$ cat /etc/passwd | awk -F ':' '$1 == "ivan" { print $5 }'
Ivan Ivanov
```
- Тази команда изписва съдържанието на петата колонка от редовете на
/etc/passwd, чиято първа колонка е ivan.
- Опцията -F позволява да изберем разделител за колонки
  - по подразбиране, колонките се разделят по произволно количество
whitespace

- awk скриптовете имат следната структура:
```
<тест> { <действие>; <действие> ... }
<тест> { <действие>; <действие> ... }
...
```
- За всеки ред от входа се изпълняват действията, чиито тестове са
успешни

### BEGIN & END ###
- BEGIN { <действие> ... }
  - изпълнява се в началото на цялото изпълнение
- END { <действие> ... }
  - изпълнява се в края на цялото изпълнение
 
### променливи ###
- Всеки awk скрипт може да ползва някои вградени променливи:
  - $0 - съдържанието на текущия ред
  - $1, $2, $3, … - съдържанието на първата, втората и т.н. колонка от текущия ред
  - NF - брой колонки в текущия ред
  - NR - брой редове, прочетени досега (т.е. номер на текущия ред)
- Освен това, можем да използваме потребителски променливи
- С опцията ‘-v =’ можем да подадем глобална променлива от shell-а на awk скрипта

Да преброим всички редове в /etc/services, които съдържат името на
даден сървис в първата колонка, подавайки името на сървиса (напр. “asp”)
като променлива:
```
$ cat /etc/services awk -v service='asp' \
'BEGIN { i = 0 } $1 == service { i += 1 } END { print i }'
```

### Регулярни изрази ###
Операторът ~ /<регулярен израз>/ е тест за регулярен израз
```
$ who | awk '$1 ~ /^s[0-9]*$/'
\\отпечатва редовете от изхода на $
who, които имат низ, състоящ се от s, последвано от произволен брой
цифри, в първата колонка
```
###  съкратен запис ###
- тестът може да липсва - тогава се подразбира true
  - ‘awk ‘{ print $3 }’ изписва третата колонка от всеки ред
- действието може да липсва - тогава се подразбира print $0
  - awk '$1 == "ivan"' изписва всички редове, чиято първа колонка е ivan

### Форматиран изход ###
Освен отпечатване на променливи с print <променлива>, можем да
отпечатваме форматиран изход с printf(), която работи като
съответната функция в C
```
$ who | awk '
BEGIN { i = 0; all = 0; }
{ all += 1 }
$2 ~ /^pts/ { i += 1 }
END {
printf(
"%.2f%% of users are logged in from PTS\n",
(i/all)*100
)
} '
```
